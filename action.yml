name: PHP Composer with Cache
author: Sam Anthony

inputs:
  GITHUB_TOKEN:
    description: Pass in the GITHUB_TOKEN
    required: true
  deployment_environment:
    description: The GitHub Deployment environment
    required: true
  deployment_status:
    description: The GitHub Deployment status, e.g FAILURE,
    required: true


runs:
  using: "composite"
  steps:
    - uses: octokit/graphql-action@v2.x
      id: api-request
      with:
        query: |
          query ($repo_owner: String!, $repo_name: String!,  $deployment_environment: String!) {
            repository(owner: $repo_owner, name: $repo_name) {
              deployments(orderBy: {field: CREATED_AT, direction: DESC}, first: 100, environments: [$deployment_environment]) {
                nodes {
                  description,
                  createdAt,
                  environment,
                  latestEnvironment,
                  latestStatus {
                    description,
                    state
                  }
                  ref {
                    name,
                    prefix
                  }
                }
              }
            }
          }
        variables: |
          repo_owner: "${{ github.event.repository.owner.name }}"
          repo_name: "${{ github.event.repository.name }}"
          deployment_environment: "${{ inputs.deployment_environment }}"
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}

    - name: Further filter/parse the GraphQL response
      shell: bash
      run: |
        mkdir ${{ runner.temp }}/dotenv
        echo '${{ steps.api-request.outputs.data }}' | jq -r '[ .repository.deployments.nodes[] | select(.latestStatus.state == "SUCCESS" and .ref.prefix == "refs/tags/") ] | limit(1;.[]) | {deployment_created_at: .createdAt, deployment_ref_name: .ref.name}  | to_entries | map("\(.key)=\(.value)") | .[]' > ${{ runner.temp }}/dotenv/.env
        cat ${{ runner.temp }}/dotenv/.env

    - name: Load dotenv file
      uses: xom9ikk/dotenv@v2
      with:
        path: ${{ runner.temp }}/dotenv

    - name: Use vars
      shell: bash
      run: |
        echo "${{ env.deployment_created_at }}"